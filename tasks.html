<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Small_car</title>
    <script type="text/javascript" src="./js/three.js"></script>
    <script type="text/javascript" src="./js/TrackballControls.js"></script>
    <script type="text/javascript" src="./js/MTLLoader.js"></script>
    <script type="text/javascript" src="./js/OBJLoader.js"></script>
    <script type="text/javascript" src="./js/stats.min.js"></script>
    <script type="text/javascript" src="./js/physi.js"></script>
    <script type="text/javascript">
        var renderer,scene,stat;
        var controls,camera,light,ambientlight,plane,car;
        var keymap={};
        Physijs.scripts.worker = './js/physijs_worker.js';
        Physijs.scripts.ammo = './js/ammo.js';
        function init(){
            //stats
            stat = new Stats();
            stat.domElement.style.position = 'absolute';
            stat.domElement.style.right = '0px';
            stat.domElement.style.top = '0px';
            document.body.appendChild(stat.domElement);

            // render&scene
            renderer = new THREE.WebGLRenderer({
                canvas:document.getElementById('mainCanvas')
            });
            renderer.setClearColor(0x000000);
            renderer.shadowMapSoft = true;
            renderer.shadowMapEnabled = true;
            scene = new Physijs.Scene();

            // camera
            camera = new THREE.PerspectiveCamera(45, 4/3,1,1000);
            scene.add(camera);
            //camera.position.set(100,40,100);
            //camera.lookAt(new THREE.Vector3(0,0,0));


            //track ball control
            /*
            controls = new THREE.TrackballControls( camera );
            controls.rotateSpeed = 1.0;
            controls.zoomSpeed = 1.2;
            controls.panSpeed = 0.8;
            controls.noZoom = false;
            controls.noPan = false;
            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;
            controls.keys = [ 65, 83, 68 ];
            */
            //small ball

            var ballMaterial = new THREE.MeshLambertMaterial({
                color:0x0000ff
            });
            var ballGeometry = new THREE.SphereGeometry(3,8,6);
            var ballMesh = new Physijs.SphereMesh(ballGeometry,ballMaterial);
            ballMesh.__dirtyPosition= true;
            ballMesh.__dirtyRotation= true;
            ballMesh.position.set(0,4,0);
            ballMesh.addEventListener('collision',function(){
                alert('aaa');
            });
            scene.add(ballMesh);

            //point light
            light = new THREE.PointLight(0xffffff,1,100,2);
            light.position.set(-20,40,20);
            light.castShadow = true;
            scene.add(light);

            //ambient light
            ambientlight = new THREE.AmbientLight(0xffffff,0.3);
            scene.add(ambientlight);

            //plane:
            plane = new THREE.Mesh(new THREE.PlaneGeometry(100,100),
                new THREE.MeshLambertMaterial({
                    map: THREE.ImageUtils.loadTexture('./img/2.jpg',{},function(){
                        renderer.render(scene,camera);
                    })
                }));
            plane.rotation.x= -Math.PI/2;
            plane.position.y= 0;
            plane.receiveShadow=true;
            scene.add(plane);

            //car loaded from obj file
            var mtlLoader = new THREE.MTLLoader();
            mtlLoader.setPath('./lib/');
            mtlLoader.load('car.mtl',function (materials) {
                materials.preload();

                //load model
                var objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(materials);
                objLoader.setPath('./lib/');
                objLoader.load('car.obj',function (object) {
                    car = object;
                    object.castShadow=true;
                    object.rotation.y= Math.PI/2;
                    object.position.set(0,0,0);
                    object.scale.x = 0.006;
                    object.scale.y = 0.006;
                    object.scale.z = 0.006;
                    object.matrixWorldNeedsUpdate = true;
                    chaseCamera();
                    scene.add(object);
                })
            });

            document.addEventListener('keydown',keyboarddown,false);
            document.addEventListener('keyup',keyboardup,false);

        }
        function animate() {
            stat.begin();
            requestAnimationFrame( animate );
            movement();

            //controls.update();
            renderer.render(scene,camera);
            scene.simulate();
            stat.end();
        }
        function keyboarddown(){
            keymap[event.keyCode]=true;
        }
        function keyboardup() {
            keymap[event.keyCode] = false;
        }
        function movement() {
            var speed = 0.5;
            var rotateSpeed = Math.PI/60;
            if (keymap[87]== true && keymap[65]==true){
                car.translateZ(-speed);
                car.rotation.y += rotateSpeed;
                chaseCamera();
            }
            else if (keymap[87]== true && keymap[68]==true){
                car.translateZ(-speed);
                car.rotation.y -= rotateSpeed;
                chaseCamera();
            }
            else if (keymap[83]== true && keymap[65]==true){
                car.translateZ(speed);
                car.rotation.y -= rotateSpeed;
                chaseCamera();
            }
            else if (keymap[83]== true && keymap[68]==true){
                car.translateZ(speed);
                car.rotation.y += rotateSpeed;
                chaseCamera();
            }
            else if (keymap[87]== true){
                car.translateZ(-speed);
                chaseCamera();
            }
            else if (keymap[83]==true){
                car.translateZ(speed);
                chaseCamera();
            }
        }
        function chaseCamera(){
            //var carPosition = new THREE.Vector3();
            //var carPositionOffset = carPosition.applyMatrix4(car.matrixWorld);
            var carPositionOffset = new THREE.Vector3();
            carPositionOffset.setFromMatrixPosition(car.matrixWorld);
            camera.position.x = carPositionOffset.x+30;
            camera.position.y = carPositionOffset.y+17;
            camera.position.z = carPositionOffset.z;
            camera.lookAt(new THREE.Vector3(carPositionOffset.x, carPositionOffset.y+10, carPositionOffset.z));
            //scene.add(camera);
        }
    </script>
</head>
<body onload="init(),animate()">
    <canvas id="mainCanvas" width="1200px" height="900px"></canvas>
</body>
</html>